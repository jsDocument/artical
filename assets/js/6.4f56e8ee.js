(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{174:function(t,s,a){t.exports=a.p+"assets/img/event.6fef92d4.png"},175:function(t,s,a){t.exports=a.p+"assets/img/dispatchEvent.b311c502.png"},325:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h3",{attrs:{id:"react-syntheticevent-事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-syntheticevent-事件"}},[t._v("#")]),t._v(" react SyntheticEvent 事件")]),t._v(" "),n("ol",[n("li",[t._v("为什么要自定义事件机制？\n"),n("ol",[n("li",[t._v("抹平不同浏览器的差异，实现更好的跨平台。")]),t._v(" "),n("li",[t._v("与内部的「优先级机制」绑定，方便事件统一管理和事务机制。")]),t._v(" "),n("li",[t._v("避免垃圾回收，React 引入"),n("code",[t._v("事件池")]),t._v("，在事件池中获取或释放事件对象，避免"),n("code",[t._v("频繁地去创建和销毁")]),t._v("。")])])])]),t._v(" "),n("h4",{attrs:{id:"react-事件系统的核心功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-事件系统的核心功能"}},[t._v("#")]),t._v(" React 事件系统的核心功能")]),t._v(" "),n("ul",[n("li",[t._v("Synthetic Event：\n"),n("ul",[n("li",[t._v("是浏览器原生事件对象的一层封装。兼容所有浏览器，同时拥有和浏览器原生事件相同的API，")]),t._v(" "),n("li",[t._v("接收原生事件对象，返回一个包装对象。原生事件对象会保存在nativeEvent属性中。")])])]),t._v(" "),n("li",[t._v("模拟实现时间的传播机制\n"),n("ul",[n("li",[t._v("在根节点绑定"),n("code",[t._v("事件类型")]),t._v("对应的事件回调，所有子孙节点触发该类事件最终都会委托给根节点的事件回调处理。")]),t._v(" "),n("li",[t._v("寻找"),n("code",[t._v("触发事件的DOM节点")]),t._v("，找到其对应的 "),n("code",[t._v("FiberNode")])]),t._v(" "),n("li",[t._v("收集从当前 FiberNode 到 根FiberNode 之间所有注册的该事件对应回调")]),t._v(" "),n("li",[t._v("反向遍历并执行一遍所有收集的回调（模拟捕获阶段的实现）")]),t._v(" "),n("li",[t._v("正向遍历并执行一遍所有收集的回调（模拟冒泡阶段的实现）")])])])]),t._v(" "),n("h4",{attrs:{id:"react-时间系统的执行顺序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-时间系统的执行顺序"}},[t._v("#")]),t._v(" React 时间系统的执行顺序")]),t._v(" "),n("ol",[n("li",[t._v("事件初始化")]),t._v(" "),n("li",[t._v("事件注册")]),t._v(" "),n("li",[t._v("事件绑定")]),t._v(" "),n("li",[t._v("事件触发")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(174),alt:"React 时间系统"}})]),t._v(" "),n("ul",[n("li",[t._v("初始化执行之后，fiber对象节点的 memoizedProps 和 pendingProps 保存了我们的事件")]),t._v(" "),n("li",[t._v("声明事件保存的位置，并非是事件真正的注册的节点")]),t._v(" "),n("li",[t._v("如：button上绑定了 oncClick 事件，但实际渲染时 button 上绑定了两个事件，一个是document上的事件监听器，另外一个是button，但事件处理函数是 noop，而是绑定在 document 上了，故结论是：")])]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("总结")]),t._v(" "),n("ol",[n("li",[t._v("jsx 中的事件没有绑定在真实的对应的 dom 上，而是绑定在 "),n("code",[t._v("document 上统一管理")])]),t._v(" "),n("li",[t._v("真实 dom 上的 click 事件被单独处理，被换成了空函数")]),t._v(" "),n("li",[t._v("对于有的事件，比如onChange，绑定到 document 可能有多个事件与之对应")]),t._v(" "),n("li",[t._v("react并不是一开始，把所有的事件都绑定在document上，而是采取了一种"),n("code",[t._v("按需绑定")]),t._v("，比如发现了onClick事件,再去绑定document click事件。")])])]),t._v(" "),n("h4",{attrs:{id:"react-事件如何合成"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-事件如何合成"}},[t._v("#")]),t._v(" react 事件如何合成")]),t._v(" "),n("ul",[n("li",[t._v("namesToPlugins 装"),n("code",[t._v("事件名")]),t._v(" 到 "),n("code",[t._v("事件模块插件")]),t._v("的映射")]),t._v(" "),n("li",[t._v("plugins 上面注册的所有插件列表")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" namesToPlugins "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  SimpleEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理各个事件函数的插件，比如一次点击事件，就会找到SimpleEventPlugin对应的处理函数")]),t._v("\n  EnterLeaveEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ChangeEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  SelectEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  BeforeInputEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v("  plugins "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("LegacySimpleEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" LegacyEnterLeaveEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("ul",[n("li",[t._v("registrationNameModules 记录了"),n("code",[t._v("React合成的事件")]),t._v("与"),n("code",[t._v("对应的事件插件")]),t._v("的关系，处理props中事件的时候，会根据不同的事件名称，找到对应的事件插件，然后统一绑定在document上")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件对应的事件插件")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onBlur")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" SimpleEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onClick")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" SimpleEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onClickCapture")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" SimpleEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onChange")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangeEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onChangeCapture")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangeEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onMouseEnter")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EnterLeaveEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onMouseLeave")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EnterLeaveEventPlugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])]),n("ul",[n("li",[t._v("事件插件是什么？是一个对象，有两个属性，第一个extractEvents作为事件统一处理函数，第二个eventTypes是一个对象，对象保存了原生事件名和对应的配置项dispatchConfig的映射关系")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SimpleEventPlugin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("eventTypes")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'click'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 处理点击事件  */")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("phasedRegistrationNames")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("bubbled")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'onClick'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对应的事件冒泡 - onClick")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("captured")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'onClickCapture'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//对应事件捕获阶段 - onClickCapture")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("dependencies")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//事件依赖")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'blur'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 处理失去焦点事件 */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("extractEvents")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetInst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* eventTypes 里面的事件对应的统一事件处理函数，接下来会重点讲到 */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("ul",[n("li",[t._v("registrationNameDependencies 用来记录，合成事件和原生事件的对应关系")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 合成事件 与 原生事件的对应关系")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onBlur")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'blur'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onClick")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onClickCapture")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onChange")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'blur'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'change'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'focus'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'input'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'keydown'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'keyup'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'selectionchange'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onMouseEnter")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mouseout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mouseover'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("onMouseLeave")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mouseout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mouseover'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("初始化定义上面的对应关系")]),t._v(" "),n("ul",[n("li",[t._v("事件初始化：主要形成了上述的几个重要对象，构建初始化React "),n("code",[t._v("合成事件")]),t._v(" 和 "),n("code",[t._v("原生事件")]),t._v(" 的对应关系，"),n("code",[t._v("合成事件")]),t._v(" 和 对应的 "),n("code",[t._v("事件处理插件")]),t._v(" 关系。\n"),n("ol",[n("li",[t._v("注册事件 injectEventPluginsByName，默认执行，形成上述的namesToPlugins")]),t._v(" "),n("li",[t._v("然后执行 recomputePluginOrdering 形成上面说的那个 plugins 数组")]),t._v(" "),n("li",[t._v("然后执行 publishEventForPlugin 形成上述的 registrationNameModules 和 registrationNameDependencies 对象中的映射关系")])])])])]),t._v(" "),n("h4",{attrs:{id:"react-事件绑定过程，是在-domdiff-阶段完成"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-事件绑定过程，是在-domdiff-阶段完成"}},[t._v("#")]),t._v(" react 事件绑定过程，是在 DOMDiff 阶段完成")]),t._v(" "),n("ul",[n("li",[t._v("事件的处理函数保存在 fiber 节点的 memoizedProps 和 pendingProps 属性上")]),t._v(" "),n("li",[t._v("React 在调合子节点后，进入 diff 阶段，如果判断 HostComponent 是 "),n("code",[t._v("5 即dom元素类型")]),t._v("，用 diff props 函数 "),n("code",[t._v("diffProperties")]),t._v(" 单独处理：即发现元素有合成事件，会调用 "),n("code",[t._v("legacyListenToEvent")]),t._v(" 函数，"),n("code",[t._v("注册事件监听器")]),t._v("。")]),t._v(" "),n("li",[t._v("legacyListenToEvent：就是执行将绑定真正的 dom 事件的函数 "),n("code",[t._v("legacyTrapBubbledEvent")]),t._v("(冒泡处理)。\n"),n("ul",[n("li",[t._v("即先找到 React 合成事件对应的原生事件集合，然后遍历依赖项的数组，绑定事件。")]),t._v(" "),n("li",[t._v("但有些特殊的事件是按照事件捕获处理的，如：scroll事件，focus 事件 ，blur事件等")])])]),t._v(" "),n("li",[t._v("事件如何绑定到 document？\n"),n("ul",[n("li",[n("code",[t._v("addTrappedEventListener")]),t._v(" 绑定事件统一处理函数 "),n("strong",[t._v("dispatchEvent")]),t._v("，绑定几个默认参数，事件类型 topLevelType ，还有绑定的容器 doucment。然后真正的事件绑定,添加事件监听器 "),n("code",[t._v("addEventListener")])])])])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// button 对应 fiber")]),t._v("\nmemoizedProps "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onClick")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handerClick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("className")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'button'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("legacyTrapBubbledEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("element")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addTrappedEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PLUGIN_EVENT_SYSTEM")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addTrappedEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("capture")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" listener "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("capture"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件捕获阶段处理函数。")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* TODO: 重要, 这里进行真正的事件绑定。*/")]),t._v("\n      targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("listener"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// document.addEventListener('click',listener,false)")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("总结")]),t._v(" "),n("ol",[n("li",[t._v("在 diff DOM 元素类型的 "),n("code",[t._v("fiber的props")]),t._v(" 的时候， 如果发现是React合成事件，比如onClick，会按照事件系统逻辑单独处理。")]),t._v(" "),n("li",[t._v("根据React合成事件类型，"),n("code",[t._v("找到对应的原生事件的类型")]),t._v("，然后"),n("code",[t._v("调用判断原生事件类型")]),t._v("，大部分事件都按照冒泡逻辑处理，少数事件会按照捕获逻辑处理。")]),t._v(" "),n("li",[t._v("调用 addTrappedEventListener 进行"),n("code",[t._v("真正的事件绑定")]),t._v("，绑定在document上，"),n("code",[t._v("dispatchEvent 为统一的事件处理函数")]),t._v("。")]),t._v(" "),n("li",[t._v("有一点值得注意: 只有上述那几个特殊事件比如 scorll,focus,blur 等是在事件捕获阶段发生的，其他的都是在事件冒泡阶段发生的，无论是 onClick 还是 onClickCapture 都是发生在冒泡阶段。")])])]),t._v(" "),n("h4",{attrs:{id:"react-事件的触发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-事件的触发"}},[t._v("#")]),t._v(" react 事件的触发")]),t._v(" "),n("p",[n("img",{attrs:{src:a(175),alt:"事件触发脉络"}})]),t._v(" "),n("ul",[n("li",[t._v("事件触发处理函数 dispatchEvent，事件触发后执行的是 dispatchEvent 函数，实际后面调用了对应的事件插件处理")]),t._v(" "),n("li",[t._v("dispatchEvent，前三个参数已经被bind了进去，所以真正的事件源对象 event，被默认"),n("code",[t._v("绑定成第四个参数")]),t._v("。")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("nativeEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 尝试调度事件 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" blockedOn "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("attemptToDispatchEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nativeEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*\ntopLevelType -> click\neventSystemFlags -> 1\ntargetContainer -> document\nnativeEvent -> 原生事件的 event 对象\n*/")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("attemptToDispatchEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetContainer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("nativeEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 获取原生事件 e.target */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" nativeEventTarget "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEventTarget")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nativeEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 获取\b当前事件，最近的dom类型fiber ，我们 demo中 button 按钮对应的 fiber */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" targetInst "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClosestInstanceFromNode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nativeEventTarget"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 重要：进入legacy模式的事件处理系统 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchEventForLegacyPluginEventSystem")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("nativeEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetInst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br")])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("总结")]),t._v(" "),n("ol",[n("li",[t._v("首先根据真实的事件源对象，"),n("code",[t._v("找到 e.target 真实的 dom 元素")]),t._v("。")]),t._v(" "),n("li",[t._v("然后根据dom元素，"),n("code",[t._v("找到与它对应的 fiber 对象targetInst")]),t._v("。")]),t._v(" "),n("li",[t._v("然后正式进去 legacy 模式的事件处理系统，也就是我们目前用的React模式都是 legacy 模式下的，在这个模式下，进行批量更新。")]),t._v(" "),n("li",[t._v("React 的冒泡和捕获并不是真正 DOM 级别的冒泡和捕获")]),t._v(" "),n("li",[t._v("React 会在一个原生事件里触发所有相关节点的 onClick 事件， 在执行这些onClick之前(派发事件时) React 会打开批量渲染开关，这个开关会将所有的setState变成异步函数。")]),t._v(" "),n("li",[t._v("事件只针对原生组件生效，自定义组件不会触发 onClick")])])]),t._v(" "),n("h4",{attrs:{id:"疑问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#疑问"}},[t._v("#")]),t._v(" 疑问")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("如何根据 dom 元素 找到对应的 fiber？")]),t._v(" "),n("ul",[n("li",[t._v("React 在初始化真实 dom 的时候，用一个随机的 key internalInstanceKey 指针指向了当前dom对应的fiber对象，fiber对象用stateNode指向了当前的dom元素。具体查找方法见----getClosestInstanceFromNode")]),t._v(" "),n("li",[t._v("真实的 DOM 的属性'__reactInternalInstance$' + randomKey 指向对应的 fiber，而属性 stateNode指向原生 DOM 元素")])])]),t._v(" "),n("li",[n("p",[t._v("legacy 事件处理系统与批量更新")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("batchedEventUpdates")]),t._v(" 为批量更新的主要函数，React通过开关 isBatchingEventUpdates 来控制是否启用批量更新")]),t._v(" "),n("li",[n("code",[t._v("handleTopLevel(bookKeeping)")]),t._v("，执行事件插件函数")]),t._v(" "),n("li",[t._v("extractEvents 形成事件对象 "),n("code",[t._v("event")]),t._v(" 和 "),n("code",[t._v("事件处理函数队列")]),t._v("，主要做的事是:\n"),n("ol",[n("li",[t._v("首先形成 React 事件独有的合成事件源对象，这个对象，保存了整个事件的信息。将"),n("code",[t._v("作为参数传递给真正的事件处理函数")]),t._v("。")]),t._v(" "),n("li",[t._v("然后声明"),n("code",[t._v("事件执行队列")]),t._v(" ，按照冒泡和捕获逻辑，从事件源开始逐渐向上，查找 dom 元素类型对应的 fiber ，收集上面的 React 合成事件，例如 onClick / onClickCapture ，对于冒泡阶段的事件(onClick)，将 push 到执行"),n("code",[t._v("队列后面")]),t._v(" ， 对于捕获阶段的事件(onClickCapture)，将 unShift到执行"),n("code",[t._v("队列的前面")]),t._v("。")]),t._v(" "),n("li",[t._v("最后将事件执行队列，保存到React事件源对象上。等待执行。")])])]),t._v(" "),n("li",[t._v("事件触发："),n("code",[t._v("runEventsInBatch")]),t._v(" 所有事件绑定函数，就是在这里触发的。dispatchListeners"),n("a",{attrs:{href:"event"}},[t._v("i")]),t._v("就是执行我们的事件处理函数\n"),n("ul",[n("li",[t._v("所以在事件处理函数中，返回 false ，并不会阻止浏览器默认行为。应该使用e.preventDefault()")]),t._v(" "),n("li",[t._v("阻止冒泡，就是 e.isPropagationStopped()")])])])])])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* topLevelType - click事件 ｜ eventSystemFlags = 1 ｜ nativeEvent = 事件源对象  ｜ targetInst = 元素对应的fiber对象  */")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchEventForLegacyPluginEventSystem")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("nativeEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetInst")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// bookKeeping为事件执行时组件的层级关系存储，也就是如果在事件执行过程中发生组件结构变更，并不会影响事件的触发流程")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" bookKeeping "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTopLevelCallbackBookKeeping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topLevelType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("nativeEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("targetInst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("eventSystemFlags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 执行批量更新 handleTopLevel 为事件处理的主要函数 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("batchedEventUpdates")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handleTopLevel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bookKeeping"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 释放事件池 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("releaseTopLevelCallbackBookKeeping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bookKeeping"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("batchedEventUpdates")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("a")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    isBatchingEventUpdates "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handleTopLevel(bookKeeping)")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        isBatchingEventUpdates "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])]),n("h4",{attrs:{id:"事件池概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件池概念"}},[t._v("#")]),t._v(" 事件池概念")]),t._v(" "),n("p",[t._v("每次我们用的事件源对象，在事件函数执行之后，可以通过releaseTopLevelCallbackBookKeeping等方法将事件源对象释放到事件池中，这样的好处每次我们不必再创建事件源对象，可以从事件池中取出一个事件源对象进行复用，在事件处理函数执行完毕后,会释放事件源到事件池中，清空属性")]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("事件触发总结")]),t._v(" "),n("ol",[n("li",[t._v("首先通过统一的事件处理函数 dispatchEvent,进行批量更新batchUpdate。")]),t._v(" "),n("li",[t._v("然后执行事件对应的处理插件中的extractEvents，合成事件源对象,每次React会从事件源开始，从上遍历类型为 hostComponent即 dom类型的fiber,判断props中是否有当前事件比如onClick,最终形成一个事件执行队列，React就是用这个队列，来模拟事件捕获->事件源->事件冒泡这一过程。")]),t._v(" "),n("li",[t._v("最后通过runEventsInBatch执行事件队列，如果发现阻止冒泡，那么break跳出循环，最后重置事件源，放回到事件池中，完成整个流程。")])])]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("react v17 事件系统 与 v16 的差异")]),t._v(" "),n("ol",[n("li",[t._v("事件统一绑定 container 上，这样好处是有利于微前端的")]),t._v(" "),n("li",[t._v("支持了原生捕获事件的支持，onScroll 事件不再进行事件冒泡。onFocus 和 onBlur 使用原生 focusin， focusout 合成")]),t._v(" "),n("li",[t._v("取消事件池复用")])])]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("注意事项")]),t._v(" "),n("p",[t._v("绑定事件尽量不要使用箭头函数，使用箭头函数，导致每次渲染时都会创建一个新的事件处理器，这会导致 ChildComponent 每次都会被渲染。")])])])}],e=a(0),r=Object(e.a)({},(function(){var t=this.$createElement;this._self._c;return this._m(0)}),n,!1,null,null,null);s.default=r.exports}}]);