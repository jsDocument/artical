<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>- 借助于抽象语法树 AST，从字符串中提取出元素的标签、属性、变量插值等有效信息。 | 黑盒子·技术积累</title>
    <meta name="description" content="前端知识学习轨迹">
    
    
    <link rel="preload" href="/assets/css/0.styles.6aaa91c1.css" as="style"><link rel="preload" href="/assets/js/app.53e266ef.js" as="script"><link rel="preload" href="/assets/js/183.4535edda.js" as="script"><link rel="prefetch" href="/assets/js/10.65134743.js"><link rel="prefetch" href="/assets/js/100.edcdb298.js"><link rel="prefetch" href="/assets/js/101.435f0869.js"><link rel="prefetch" href="/assets/js/102.21da200a.js"><link rel="prefetch" href="/assets/js/103.f65f4c72.js"><link rel="prefetch" href="/assets/js/104.dbe34b6d.js"><link rel="prefetch" href="/assets/js/105.8d5b64ff.js"><link rel="prefetch" href="/assets/js/106.5dbd0271.js"><link rel="prefetch" href="/assets/js/107.c9363391.js"><link rel="prefetch" href="/assets/js/108.836056d0.js"><link rel="prefetch" href="/assets/js/109.f0f0eb1f.js"><link rel="prefetch" href="/assets/js/11.8d57e3cd.js"><link rel="prefetch" href="/assets/js/110.0073f72a.js"><link rel="prefetch" href="/assets/js/111.9ba325f4.js"><link rel="prefetch" href="/assets/js/112.08fbd40a.js"><link rel="prefetch" href="/assets/js/113.c9da6aa7.js"><link rel="prefetch" href="/assets/js/114.15c23113.js"><link rel="prefetch" href="/assets/js/115.be405170.js"><link rel="prefetch" href="/assets/js/116.3e29fb4f.js"><link rel="prefetch" href="/assets/js/117.0003be20.js"><link rel="prefetch" href="/assets/js/118.01454b1f.js"><link rel="prefetch" href="/assets/js/119.4f813a92.js"><link rel="prefetch" href="/assets/js/12.ebce4ebd.js"><link rel="prefetch" href="/assets/js/120.b0b2e874.js"><link rel="prefetch" href="/assets/js/121.7bcd6cb7.js"><link rel="prefetch" href="/assets/js/122.68e73afa.js"><link rel="prefetch" href="/assets/js/123.d8e5ef43.js"><link rel="prefetch" href="/assets/js/124.3e3f5c26.js"><link rel="prefetch" href="/assets/js/125.1a020a12.js"><link rel="prefetch" href="/assets/js/126.d582114c.js"><link rel="prefetch" href="/assets/js/127.7b1f520f.js"><link rel="prefetch" href="/assets/js/128.4a5e3787.js"><link rel="prefetch" href="/assets/js/129.357354f5.js"><link rel="prefetch" href="/assets/js/13.b45d341e.js"><link rel="prefetch" href="/assets/js/130.32686c00.js"><link rel="prefetch" href="/assets/js/131.b0a57325.js"><link rel="prefetch" href="/assets/js/132.089f2cf8.js"><link rel="prefetch" href="/assets/js/133.f398bcef.js"><link rel="prefetch" href="/assets/js/134.7cd23d13.js"><link rel="prefetch" href="/assets/js/135.9d6b3bb3.js"><link rel="prefetch" href="/assets/js/136.634f39f2.js"><link rel="prefetch" href="/assets/js/137.4225c9ed.js"><link rel="prefetch" href="/assets/js/138.3524e04a.js"><link rel="prefetch" href="/assets/js/139.090f709d.js"><link rel="prefetch" href="/assets/js/14.c9723882.js"><link rel="prefetch" href="/assets/js/140.cc559854.js"><link rel="prefetch" href="/assets/js/141.6a3098a2.js"><link rel="prefetch" href="/assets/js/142.e5d240b9.js"><link rel="prefetch" href="/assets/js/143.4122507f.js"><link rel="prefetch" href="/assets/js/144.8a8842a5.js"><link rel="prefetch" href="/assets/js/145.55c6956b.js"><link rel="prefetch" href="/assets/js/146.258ed128.js"><link rel="prefetch" href="/assets/js/147.b97aad1d.js"><link rel="prefetch" href="/assets/js/148.92928163.js"><link rel="prefetch" href="/assets/js/149.90a05f04.js"><link rel="prefetch" href="/assets/js/15.5c8969d9.js"><link rel="prefetch" href="/assets/js/150.4656c394.js"><link rel="prefetch" href="/assets/js/151.32ef9274.js"><link rel="prefetch" href="/assets/js/152.a007161e.js"><link rel="prefetch" href="/assets/js/153.6a0aabb3.js"><link rel="prefetch" href="/assets/js/154.f3cc11d0.js"><link rel="prefetch" href="/assets/js/155.1f0f0049.js"><link rel="prefetch" href="/assets/js/156.022881cd.js"><link rel="prefetch" href="/assets/js/157.1dfc75fd.js"><link rel="prefetch" href="/assets/js/158.8c0ce2d0.js"><link rel="prefetch" href="/assets/js/159.d65e6462.js"><link rel="prefetch" href="/assets/js/16.99a00e7e.js"><link rel="prefetch" href="/assets/js/160.7a8fab95.js"><link rel="prefetch" href="/assets/js/161.cf36e107.js"><link rel="prefetch" href="/assets/js/162.05ef6079.js"><link rel="prefetch" href="/assets/js/163.01087eb6.js"><link rel="prefetch" href="/assets/js/164.4cb8666c.js"><link rel="prefetch" href="/assets/js/165.08a9fd5c.js"><link rel="prefetch" href="/assets/js/166.af8016d5.js"><link rel="prefetch" href="/assets/js/167.94fc4700.js"><link rel="prefetch" href="/assets/js/168.6ab9b48f.js"><link rel="prefetch" href="/assets/js/169.97bd04ac.js"><link rel="prefetch" href="/assets/js/17.df2a4eb4.js"><link rel="prefetch" href="/assets/js/170.f8c6be84.js"><link rel="prefetch" href="/assets/js/171.641c932f.js"><link rel="prefetch" href="/assets/js/172.bf3db2f4.js"><link rel="prefetch" href="/assets/js/173.ae10cce5.js"><link rel="prefetch" href="/assets/js/174.f4bf5aaa.js"><link rel="prefetch" href="/assets/js/175.4ab1b991.js"><link rel="prefetch" href="/assets/js/176.9f2a4d72.js"><link rel="prefetch" href="/assets/js/177.81341ab0.js"><link rel="prefetch" href="/assets/js/178.8fba3329.js"><link rel="prefetch" href="/assets/js/179.949fdcc3.js"><link rel="prefetch" href="/assets/js/18.78753ebb.js"><link rel="prefetch" href="/assets/js/180.7fdb370a.js"><link rel="prefetch" href="/assets/js/181.68936906.js"><link rel="prefetch" href="/assets/js/182.6af71721.js"><link rel="prefetch" href="/assets/js/184.165558bc.js"><link rel="prefetch" href="/assets/js/185.56598814.js"><link rel="prefetch" href="/assets/js/186.2ffb9d14.js"><link rel="prefetch" href="/assets/js/187.b6f015cc.js"><link rel="prefetch" href="/assets/js/188.c10d4322.js"><link rel="prefetch" href="/assets/js/189.1d556cd4.js"><link rel="prefetch" href="/assets/js/19.8f00b3f8.js"><link rel="prefetch" href="/assets/js/190.525bc3a7.js"><link rel="prefetch" href="/assets/js/191.83bc9e54.js"><link rel="prefetch" href="/assets/js/192.fa2d48ff.js"><link rel="prefetch" href="/assets/js/193.27effd38.js"><link rel="prefetch" href="/assets/js/194.d849610b.js"><link rel="prefetch" href="/assets/js/195.3a7313a0.js"><link rel="prefetch" href="/assets/js/196.96f12b40.js"><link rel="prefetch" href="/assets/js/197.354a6d50.js"><link rel="prefetch" href="/assets/js/198.9ef5d4c5.js"><link rel="prefetch" href="/assets/js/199.4327cf34.js"><link rel="prefetch" href="/assets/js/2.6d2e3f4b.js"><link rel="prefetch" href="/assets/js/20.5d31049a.js"><link rel="prefetch" href="/assets/js/200.533a4abd.js"><link rel="prefetch" href="/assets/js/201.9e8d3530.js"><link rel="prefetch" href="/assets/js/202.376739a1.js"><link rel="prefetch" href="/assets/js/203.5985aa2b.js"><link rel="prefetch" href="/assets/js/204.42b86cfb.js"><link rel="prefetch" href="/assets/js/205.a2fd3ed6.js"><link rel="prefetch" href="/assets/js/206.f948b1f4.js"><link rel="prefetch" href="/assets/js/207.17b7eefe.js"><link rel="prefetch" href="/assets/js/208.56aedf3c.js"><link rel="prefetch" href="/assets/js/209.078f1d9a.js"><link rel="prefetch" href="/assets/js/21.0e9105df.js"><link rel="prefetch" href="/assets/js/210.b6932ce8.js"><link rel="prefetch" href="/assets/js/211.4954982f.js"><link rel="prefetch" href="/assets/js/212.1907420f.js"><link rel="prefetch" href="/assets/js/213.d9c88070.js"><link rel="prefetch" href="/assets/js/214.a5dd1ea7.js"><link rel="prefetch" href="/assets/js/215.d924acad.js"><link rel="prefetch" href="/assets/js/216.05d3016c.js"><link rel="prefetch" href="/assets/js/217.313972da.js"><link rel="prefetch" href="/assets/js/218.9796a542.js"><link rel="prefetch" href="/assets/js/22.40c83017.js"><link rel="prefetch" href="/assets/js/23.50e6d6ff.js"><link rel="prefetch" href="/assets/js/24.4a2f91c4.js"><link rel="prefetch" href="/assets/js/25.bcd3d997.js"><link rel="prefetch" href="/assets/js/26.1d09d398.js"><link rel="prefetch" href="/assets/js/27.c13cdd01.js"><link rel="prefetch" href="/assets/js/28.d155f933.js"><link rel="prefetch" href="/assets/js/29.c1ea88cd.js"><link rel="prefetch" href="/assets/js/3.8b3d3652.js"><link rel="prefetch" href="/assets/js/30.0e0939c8.js"><link rel="prefetch" href="/assets/js/31.d096d0b3.js"><link rel="prefetch" href="/assets/js/32.a9fd67b8.js"><link rel="prefetch" href="/assets/js/33.b8ab3f91.js"><link rel="prefetch" href="/assets/js/34.e2226023.js"><link rel="prefetch" href="/assets/js/35.5081c2d5.js"><link rel="prefetch" href="/assets/js/36.34ae22dc.js"><link rel="prefetch" href="/assets/js/37.1b8715dd.js"><link rel="prefetch" href="/assets/js/38.3110c263.js"><link rel="prefetch" href="/assets/js/39.972c3894.js"><link rel="prefetch" href="/assets/js/4.c972694d.js"><link rel="prefetch" href="/assets/js/40.eb8db093.js"><link rel="prefetch" href="/assets/js/41.4f62fb28.js"><link rel="prefetch" href="/assets/js/42.247caac1.js"><link rel="prefetch" href="/assets/js/43.45835af8.js"><link rel="prefetch" href="/assets/js/44.70093046.js"><link rel="prefetch" href="/assets/js/45.076ef641.js"><link rel="prefetch" href="/assets/js/46.b0c97590.js"><link rel="prefetch" href="/assets/js/47.188cfc7a.js"><link rel="prefetch" href="/assets/js/48.855eee86.js"><link rel="prefetch" href="/assets/js/49.4a3ab375.js"><link rel="prefetch" href="/assets/js/5.011b3f89.js"><link rel="prefetch" href="/assets/js/50.aeccab23.js"><link rel="prefetch" href="/assets/js/51.b532c2aa.js"><link rel="prefetch" href="/assets/js/52.87aec73a.js"><link rel="prefetch" href="/assets/js/53.d6c97914.js"><link rel="prefetch" href="/assets/js/54.3c552e7c.js"><link rel="prefetch" href="/assets/js/55.c0c062fb.js"><link rel="prefetch" href="/assets/js/56.e2411e6d.js"><link rel="prefetch" href="/assets/js/57.cb1271d4.js"><link rel="prefetch" href="/assets/js/58.4228e209.js"><link rel="prefetch" href="/assets/js/59.48c04d2f.js"><link rel="prefetch" href="/assets/js/6.34ddb53a.js"><link rel="prefetch" href="/assets/js/60.d3356cd7.js"><link rel="prefetch" href="/assets/js/61.e4cd6c35.js"><link rel="prefetch" href="/assets/js/62.71276191.js"><link rel="prefetch" href="/assets/js/63.556c61c9.js"><link rel="prefetch" href="/assets/js/64.cedca265.js"><link rel="prefetch" href="/assets/js/65.023654c8.js"><link rel="prefetch" href="/assets/js/66.7e80b052.js"><link rel="prefetch" href="/assets/js/67.20afac95.js"><link rel="prefetch" href="/assets/js/68.6b692212.js"><link rel="prefetch" href="/assets/js/69.4d1e497f.js"><link rel="prefetch" href="/assets/js/7.b4eff34b.js"><link rel="prefetch" href="/assets/js/70.d6c6121d.js"><link rel="prefetch" href="/assets/js/71.ebc935fd.js"><link rel="prefetch" href="/assets/js/72.86027ec8.js"><link rel="prefetch" href="/assets/js/73.33c5d698.js"><link rel="prefetch" href="/assets/js/74.e38e2caf.js"><link rel="prefetch" href="/assets/js/75.56e7a7db.js"><link rel="prefetch" href="/assets/js/76.93145b2b.js"><link rel="prefetch" href="/assets/js/77.ad3a1c9f.js"><link rel="prefetch" href="/assets/js/78.97841262.js"><link rel="prefetch" href="/assets/js/79.801ccbf7.js"><link rel="prefetch" href="/assets/js/8.b2d477ee.js"><link rel="prefetch" href="/assets/js/80.4bd08d47.js"><link rel="prefetch" href="/assets/js/81.c9f61be9.js"><link rel="prefetch" href="/assets/js/82.00c14b0e.js"><link rel="prefetch" href="/assets/js/83.2a84d9ba.js"><link rel="prefetch" href="/assets/js/84.adc0a12b.js"><link rel="prefetch" href="/assets/js/85.630c01a9.js"><link rel="prefetch" href="/assets/js/86.695e1509.js"><link rel="prefetch" href="/assets/js/87.994bb24d.js"><link rel="prefetch" href="/assets/js/88.5c981760.js"><link rel="prefetch" href="/assets/js/89.94e8006b.js"><link rel="prefetch" href="/assets/js/9.cc3a5010.js"><link rel="prefetch" href="/assets/js/90.8ab05109.js"><link rel="prefetch" href="/assets/js/91.76b937bc.js"><link rel="prefetch" href="/assets/js/92.ebdb482b.js"><link rel="prefetch" href="/assets/js/93.1078aa16.js"><link rel="prefetch" href="/assets/js/94.84a7d829.js"><link rel="prefetch" href="/assets/js/95.bd238429.js"><link rel="prefetch" href="/assets/js/96.f5c5e898.js"><link rel="prefetch" href="/assets/js/97.e7f632c9.js"><link rel="prefetch" href="/assets/js/98.d550a398.js"><link rel="prefetch" href="/assets/js/99.9d12b71c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aaa91c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">黑盒子·技术积累</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">jvascript 系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/base/" class="nav-link">jvascript 基础系列</a></li><li class="dropdown-item"><!----> <a href="/basic/promise/" class="nav-link">javascript 高阶专题系列</a></li><li class="dropdown-item"><!----> <a href="/basic/http/" class="nav-link">http 系列知识</a></li></ul></div></div><div class="nav-item"><a href="/LeetCode/" class="nav-link">leetCode系列</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具系列</a></div><div class="nav-item"><a href="/vue-resource/" class="nav-link">vue 系列</a></div><div class="nav-item"><a href="/react/" class="nav-link">react 系列</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">jvascript 系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/base/" class="nav-link">jvascript 基础系列</a></li><li class="dropdown-item"><!----> <a href="/basic/promise/" class="nav-link">javascript 高阶专题系列</a></li><li class="dropdown-item"><!----> <a href="/basic/http/" class="nav-link">http 系列知识</a></li></ul></div></div><div class="nav-item"><a href="/LeetCode/" class="nav-link">leetCode系列</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具系列</a></div><div class="nav-item"><a href="/vue-resource/" class="nav-link">vue 系列</a></div><div class="nav-item"><a href="/react/" class="nav-link">react 系列</a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id><a href="#" class="header-anchor">#</a></h1> <ul><li>借助于抽象语法树 AST，从字符串中提取出元素的标签、属性、变量插值等有效信息。</li> <li>解析成 AST 后，可以对其进行各种操作处理了，处理后的 AST用来生成 render 函数</li> <li>流程：
<ul><li>模板解析：将模板用正则解析成 AST----parser</li> <li>优化阶段：遍历 AST，找出静态节点，并打上标记-----optimizer</li> <li>代码生成阶段：将 AST 转换成渲染函数------codegen</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">template</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token comment">// 模板解析阶段：用正则等方式解析 template 模板中的指令、class、style等数据，形成AST</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 优化阶段：遍历AST，找出其中的静态节点，并打上标记；</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 代码生成阶段：将AST转换成渲染函数；</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns <span class="token comment">// 静态渲染函数</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="模板解析"><a href="#模板解析" class="header-anchor">#</a> 模板解析</h2> <ol><li>parse(template, options)
<ol><li>parseHTMl(template, {})，其中的 4 个钩子函数把提取出的内容生成对应成 AST
<ol><li>parseText(text/value, delimiters)</li> <li>parseFilters(value)</li></ol></li></ol></li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    warn<span class="token punctuation">,</span>
    <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> options<span class="token punctuation">.</span>expectHTML<span class="token punctuation">,</span>
    <span class="token literal-property property">isUnaryTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>isUnaryTag<span class="token punctuation">,</span>
    <span class="token literal-property property">canBeLeftOpenTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>canBeLeftOpenTag<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlines</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlinesForHref</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldKeepComment</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
    <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">,</span>
    <span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">end</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">chars</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">text</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">comment</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">text</span><span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> root
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> unicodeLetters <span class="token operator">=</span> <span class="token string">'a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD'</span>

<span class="token comment">// 命名规则</span>
<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unicodeLetters<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]*</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> doctype <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!DOCTYPE [^&gt;]+&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span>
<span class="token comment">// #7298: escape - to avoid being pased as HTML comment when inlined in page</span>
<span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\--</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> conditionalComment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\[</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> reCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> decodingMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'&amp;lt;'</span><span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;gt;'</span><span class="token operator">:</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;quot;'</span><span class="token operator">:</span> <span class="token string">'&quot;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;amp;'</span><span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#10;'</span><span class="token operator">:</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#9;'</span><span class="token operator">:</span> <span class="token string">'\t'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> encodedAttr <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token keyword">const</span> encodedAttrWithNewLines <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp|#10|#9);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isPlainTextElement <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'script,style,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span> <span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 维护 AST 节点层级的栈</span>
  <span class="token keyword">const</span> expectHTML <span class="token operator">=</span> options<span class="token punctuation">.</span>expectHTML
  <span class="token keyword">const</span> isUnaryTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isUnaryTag <span class="token operator">||</span> no
  <span class="token keyword">const</span> canBeLeftOpenTag <span class="token operator">=</span> options<span class="token punctuation">.</span>canBeLeftOpenTag <span class="token operator">||</span> no
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 解析游标</span>
  <span class="token keyword">let</span> last<span class="token punctuation">,</span> <span class="token comment">// 剩余未解析的模板字符串</span>
    lastTag <span class="token comment">// 位于栈顶 stack 的元素</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 剩余未处理的模板</span>
    last <span class="token operator">=</span> html
    <span class="token comment">// 栈顶没有元素 或 栈顶的 parse 的内容不是在纯文本标签里 (script,style,textarea)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastTag <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>
      <span class="token comment">// '&lt;'在第一个位置，处理一下 5 类情况</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注释的情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> commentEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--&gt;'</span><span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>commentEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果需要保留注释，则把注释截取出来传给options.comment，创建注释类型的AST节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>shouldKeepComment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              options<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> commentEnd<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> index <span class="token operator">+</span> commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 若不保留注释，则将游标移动到'--&gt;'之后，继续向后解析</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 条件注释</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> conditionalEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">']&gt;'</span><span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>conditionalEnd <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Doctype:</span>
        <span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">advance</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 标签结束:</span>
        <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> curIndex <span class="token operator">=</span> index
          <span class="token function">advance</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          <span class="token function">parseEndTag</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> curIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 标签开始:</span>
        <span class="token comment">// 忽略第一个空行</span>
        <span class="token keyword">const</span> isIgnoreNewlineTag <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'pre,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> <span class="token function-variable function">shouldIgnoreFirstNewline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tag <span class="token operator">&amp;&amp;</span> <span class="token function">isIgnoreNewlineTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> html<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'\n'</span>
        <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleStartTag</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">let</span> text<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> next
      <span class="token comment">// '&lt;'不在第一个位置，文本开头</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// '&lt;'以后的内容赋值到 rest，前面的纯文本无需处理</span>
        rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>
        <span class="token comment">// '&lt;'之后的内容去匹配 endTag, startTagOpen, comment, conditionalComment，没有匹配上，把'&lt;'当做普通的文本内容</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>
          <span class="token operator">!</span>endTag<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>startTagOpen<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// &lt; in plain text, be forgiving and treat it as text</span>
          <span class="token comment">// 匹配下一个'&lt;'，没有则结束循环</span>
          next <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span>
          <span class="token comment">// 匹配下一个'&lt;'，有则更新 textEnd 位置与 rest 的内容，继续循环</span>
          textEnd <span class="token operator">+=</span> next
          rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 截取出纯文本的内容</span>
        text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> textEnd<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 整个模板字符串都是纯文本</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        text <span class="token operator">=</span> html
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新 html 与 index</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 把截取处理的 text 转化成 textAST</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> index <span class="token operator">-</span> text<span class="token punctuation">.</span>length<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> endTagLength <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">const</span> stackedTag <span class="token operator">=</span> lastTag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> reStackedTag <span class="token operator">=</span> reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'([\\s\\S]*?)(&lt;/'</span> <span class="token operator">+</span> stackedTag <span class="token operator">+</span> <span class="token string">'[^&gt;]*&gt;)'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 对模板的里栈顶标签对应的结束标签</span>
      <span class="token keyword">const</span> rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reStackedTag<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">all<span class="token punctuation">,</span> text<span class="token punctuation">,</span> endTag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        endTagLength <span class="token operator">=</span> endTag<span class="token punctuation">.</span>length
        <span class="token comment">// parse 的内容不是在纯文本标签里 (script,style,textarea)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stackedTag <span class="token operator">!==</span> <span class="token string">'noscript'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 把注释的文本内容取出</span>
          text <span class="token operator">=</span> text
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;!\--([\s\S]*?)--&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span> <span class="token comment">// #7298</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;!\[CDATA\[([\s\S]*?)]]&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 跳过 pre, textarea 的空行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      index <span class="token operator">+=</span> html<span class="token punctuation">.</span>length <span class="token operator">-</span> rest<span class="token punctuation">.</span>length
      html <span class="token operator">=</span> rest
      <span class="token function">parseEndTag</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">,</span> index <span class="token operator">-</span> endTagLength<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 整个模板作为文本对待</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">===</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Mal-formatted tag at end of template: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">start</span><span class="token operator">:</span> index <span class="token operator">+</span> html<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clean up any remaining tags</span>
  <span class="token comment">// html字符串中的标签格式有误时会跳出while循环，此时就会执行这行代码，这行代码是调用parseEndTag函数并不传递任何参数，前面我们说过如果parseEndTag函数不传递任何参数是用于处理栈中剩余未处理的标签。这是因为如果不传递任何函数，此时parseEndTag函数里的pos就为0，那么pos&gt;=0就会恒成立，那么就会逐个警告缺少闭合标签，并调用 options.end将其闭合。</span>
  <span class="token function">parseEndTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">advance</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> n
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1. 起始位置可能有空格</span>
  <span class="token comment">// 2. (非空格、引号、尖括号、反斜线、等号)-----属性名</span>
  <span class="token comment">// 3. (等号)与前后空格</span>
  <span class="token comment">// 4. 双引号(非引号)&quot;+ 或 单引号(非d单引号)'+ 或 (非空格、引号、尖括号、等号)+</span>
  <span class="token comment">// (?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+))</span>
  <span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span>
  <span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span>

  <span class="token keyword">function</span> <span class="token function">parseStartTag</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">tagName</span><span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">start</span><span class="token operator">:</span> index
      <span class="token punctuation">}</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr
      <span class="token comment">// 解析标签开始{tagName, attrs: [{start, end, ['xx=yy',xx,=,&quot;yy&quot;]}], start}</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attr<span class="token punctuation">.</span>start <span class="token operator">=</span> index
        <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        attr<span class="token punctuation">.</span>end <span class="token operator">=</span> index
        match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 是否是自闭合标签</span>
        match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        match<span class="token punctuation">.</span>end <span class="token operator">=</span> index
        <span class="token keyword">return</span> match
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleStartTag</span> <span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> match<span class="token punctuation">.</span>tagName
    <span class="token keyword">const</span> unarySlash <span class="token operator">=</span> match<span class="token punctuation">.</span>unarySlash
    <span class="token comment">// TODO</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectHTML<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTag <span class="token operator">===</span> <span class="token string">'p'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNonPhrasingTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">parseEndTag</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canBeLeftOpenTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastTag <span class="token operator">===</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">parseEndTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> unary <span class="token operator">=</span> <span class="token function">isUnaryTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>unarySlash

    <span class="token keyword">const</span> l <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> args <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// 属性值做兼容处理</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span>
      <span class="token comment">// 需要对 a 标签的 href 制表符或换行符做兼容处理</span>
      <span class="token keyword">const</span> shouldDecodeNewlines <span class="token operator">=</span> tagName <span class="token operator">===</span> <span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'href'</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref
        <span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines
      <span class="token comment">// 将处理结果存入与 match.attrs 长度一致的数组里</span>
      attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> shouldDecodeNewlines<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> args<span class="token punctuation">.</span>start <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
        attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> args<span class="token punctuation">.</span>end
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 非自闭合标签，就推入栈中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> tagName<span class="token punctuation">,</span> <span class="token literal-property property">lowerCasedTag</span><span class="token operator">:</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">attrs</span><span class="token operator">:</span> attrs<span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> match<span class="token punctuation">.</span>end <span class="token punctuation">}</span><span class="token punctuation">)</span>
      lastTag <span class="token operator">=</span> tagName
    <span class="token punctuation">}</span>
    <span class="token comment">// 自闭合标签，调用 start 钩子来创建 AST节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> match<span class="token punctuation">.</span>end<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">parseEndTag</span> <span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> pos<span class="token punctuation">,</span> lowerCasedTagName
    <span class="token comment">// 做剩余标签清理时，使用当前 index</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> start <span class="token operator">=</span> index
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> end <span class="token operator">=</span> index

    <span class="token comment">// 从栈顶位置从后向前遍历栈，寻找 tagName 所在位置 pos</span>
    <span class="token comment">// TODO</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lowerCasedTagName <span class="token operator">=</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> pos<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>lowerCasedTag <span class="token operator">===</span> lowerCasedTagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// If no tag name is provided, clean shop</span>
      pos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Close all the open elements, up the stack</span>
      <span class="token comment">// 从栈顶位置向前遍历，如果stack 中发现存在索引大于 pos 的元素，该元素一定是确实闭合标签</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> pos<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> pos <span class="token operator">||</span> <span class="token operator">!</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          options<span class="token punctuation">.</span>warn
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 因为在正常情况下，stack栈的栈顶元素应该和当前的结束标签tagName 匹配，也就是说正常的pos应该是栈顶位置，后面不应该再有元素，如果后面还有元素，那么后面的元素就都缺少闭合标签</span>
          options<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tag &lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt; has no matching end tag.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token literal-property property">start</span><span class="token operator">:</span> stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 还会调用 options.end(stack[i].tag, start, end)立即将其闭合，这是为了保证解析结果的正确性。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Remove the open elements from the stack</span>
      <span class="token comment">// 最后把pos位置以后的元素都从stack栈中弹出，以及把lastTag更新为栈顶元素</span>
      stack<span class="token punctuation">.</span>length <span class="token operator">=</span> pos
      lastTag <span class="token operator">=</span> pos <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tag
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">'br'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建&lt;br&gt;AST节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">'p'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于&lt;/p&gt;浏览器则自动将其补全为&lt;p&gt;&lt;/p&gt;，所以Vue为了与浏览器对这两个标签的行为保持一致，故对这两个便签单独判断处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br></div></div><h2 id="涉及到的函数"><a href="#涉及到的函数" class="header-anchor">#</a> 涉及到的函数</h2> <ul><li>根据正则匹配内容的结束位置，更新模板匹配的位置 index 与 剩余未匹配的模板 html----advance(n)游标
<ul><li>注释，是否更新到 AST</li> <li>条件注释，不需要钩子函数创建 AST，直接截掉即可</li> <li>DOCTYPE，与条件解析</li></ul></li></ul> <h2 id="大致流程"><a href="#大致流程" class="header-anchor">#</a> 大致流程</h2> <ol><li>按模板从前往后分析
<ol><li>遇到非自闭合标签，入栈</li> <li>遇到自闭合标签，直接转场 AST</li> <li>注释节点，如果需要保留，创建 commentAST，条件注释节点不处理</li> <li>遇到文本转成 TextAST</li></ol></li> <li>代码分支逻辑：
<ol><li>还没有栈顶标签，或栈顶标签不是 TextArea, style, script
<ol><li><code>&lt;</code>在开始位置
<ol><li>是注释，执行 comment 钩子，根据条件创建注释 AST，且根据注释结束位置，移动游标</li> <li>条件注释，同上</li> <li>Doctype 同上</li> <li>标签结束，移动游标，解析结束标签<code>parseEndTag</code></li> <li>标签开始，先parseStartTag，再处理开始标签<code>handleStartTag</code>，移动游标</li></ol></li> <li><code>&lt;</code> 不在开始位置，忽略<code>&lt;</code>前面的文本，直接更新 rest
<ol><li>判断<code>&lt;</code>之后不是endTag、startTagOpen、comment、conditionalComment，把<code>&lt;</code>当普通文本处理，继续寻找下一个'&lt;',没有就结束循环</li> <li>整个没有'&lt;'，整个都是普通文本</li> <li>更新游标位置，执行 chars 钩子</li></ol></li></ol></li> <li>处理没有闭合的标签，根据栈顶标签，创建对应的正则，
<ol><li>匹配出标签结束之前的文本
<ol><li>注释&lt;!--([\s\S]<em>?)--&gt;/g, &lt;![CDATA[([\s\S]</em>?)]]&gt;/g，只留中间的文本内容</li> <li>去掉 pre, textarea 里面的第一个\n</li> <li>执行 chars 钩子，并返回 ‘’</li></ol></li> <li>更新游标、剩余模板并解析结束标签</li> <li>整个模板是文本，执行 chars 钩子</li></ol></li> <li>处理仍然未被处理的结束标签</li></ol></li> <li>解析结束标签parseEndTag，分为 3 种情况
<ol><li>有 tagName，找到 tagName 在stack栈里的位置 pos
<ol><li>在 stack 里面找，pos 之后是否存在该 tagName，存在证明没有闭合，警告，执行 end 钩子</li></ol></li> <li>有 tagName，更新 pos = 0，做清理用</li> <li>如果是 br ，执行 start 钩子----createASTElement</li> <li>如果是 p，执行 start 钩子----createASTElement，执行 end 钩子</li></ol></li> <li>解析标签开始 parseStartTag，把数据更新到对象 match 上
<ol><li>正则<code>startTagOpen</code>匹配出 tag 的开始位置与tagName, 移动游标</li> <li>循环匹配非<code>startTagClose</code> 并匹配出attribute，更新 attr.start，移动游标再更新 attr.end，更新到队列中</li> <li>startTagClose匹配成功，即自闭合标签，执行 end 钩子，更新游标，更新并返回 match</li></ol></li> <li>处理开始标签 handleStartTag
<ol><li>解析属性，解析成 {attr:[name, value]}</li> <li>不是自闭合标签，入栈</li> <li>是自闭合标签，执行 start钩子，创建节点 AST</li></ol></li></ol></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.53e266ef.js" defer></script><script src="/assets/js/183.4535edda.js" defer></script>
  </body>
</html>
