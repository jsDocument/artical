(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{483:function(t,s,n){"use strict";n.r(s);var a=n(54),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"cors-如果需要指定多个域名怎么办"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cors-如果需要指定多个域名怎么办"}},[t._v("#")]),t._v(" CORS 如果需要指定多个域名怎么办")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("Issue")]),t._v(" "),n("p",[t._v("欢迎在 Gtihub Issue 中回答此问题: "),n("a",{attrs:{href:"https://github.com/shfshanyue/Daily-Question/issues/364",target:"_blank",rel:"noopener noreferrer"}},[t._v("Issue 364"),n("OutboundLink")],1)])]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("Author")]),t._v(" "),n("p",[t._v("回答者: "),n("a",{attrs:{href:"https://github.com/shfshanyue",target:"_blank",rel:"noopener noreferrer"}},[t._v("shfshanyue"),n("OutboundLink")],1)])]),t._v(" "),n("p",[n("code",[t._v("CORS")]),t._v(" 通过控制 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 控制哪些域名可以共享资源，取值如下")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("Access-Control-Allow-Origin: "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("origin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" *\n")])])]),n("p",[t._v("其中 "),n("code",[t._v("*")]),t._v(" 代表所有域名，"),n("code",[t._v("origin")]),t._v(" 代表指定特定域名，那如何设置多个域名了？")]),t._v(" "),n("p",[t._v("此时需要通过代码实现，"),n("strong",[t._v("根据请求头中的 "),n("code",[t._v("Origin")]),t._v(" 来设置响应头 "),n("code",[t._v("Access-Control-Allow-Origin")])]),t._v("，那 Origin 又是什么东西？")]),t._v(" "),n("h2",{attrs:{id:"请求头-origin"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#请求头-origin"}},[t._v("#")]),t._v(" 请求头: Origin")]),t._v(" "),n("p",[t._v("并不是所有请求都会自动带上 "),n("code",[t._v("Origin")]),t._v("，在浏览器中带 "),n("code",[t._v("Origin")]),t._v(" 的逻辑如下")]),t._v(" "),n("ol",[n("li",[t._v("如果存在跨域，则带上 "),n("code",[t._v("Origin")]),t._v("，值为当前域名")]),t._v(" "),n("li",[t._v("如果不存在跨域，则不带 "),n("code",[t._v("Origin")])])]),t._v(" "),n("p",[t._v("逻辑理清楚后，关于服务器中对于 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 设置多域名的逻辑也很清晰了")]),t._v(" "),n("ol",[n("li",[t._v("如果请求头不带有 "),n("code",[t._v("Origin")]),t._v("，证明未跨域，则不作任何处理")]),t._v(" "),n("li",[t._v("如果请求头带有 "),n("code",[t._v("Origin")]),t._v("，证明跨域，根据 "),n("code",[t._v("Origin")]),t._v(" 设置相应的 "),n("code",[t._v("Access-Control-Allow-Origin: <Origin>")])])]),t._v(" "),n("p",[t._v("使用伪代码实现如下:")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 Origin 请求头")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestOrigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果没有，则跳过")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置响应头")]),t._v("\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h2",{attrs:{id:"vary-origin"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#vary-origin"}},[t._v("#")]),t._v(" Vary: Origin")]),t._v(" "),n("p",[t._v("此时可以给多个域名控制 CORS，但此时假设有两个域名访问 "),n("code",[t._v("static.shanyue.tech")]),t._v(" 的跨域资源")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("foo.shanyue.tech")]),t._v("，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: foo.shanyue.tech")])]),t._v(" "),n("li",[n("code",[t._v("bar.shanyue.tech")]),t._v("，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: bar.shanyue.tech")])])]),t._v(" "),n("p",[t._v("看起来一切正常，但如果中间有缓存怎么办？")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("foo.shanyue.tech")]),t._v("，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: foo.shanyue.tech")]),t._v("，被 CDN 缓存")]),t._v(" "),n("li",[n("strong",[n("code",[t._v("bar.shanyue.tech")]),t._v("，因由缓存，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: foo.shanyue.tech")]),t._v("，跨域出现问题")])])]),t._v(" "),n("p",[t._v("此时，"),n("code",[t._v("Vary: Origin")]),t._v(" 就上场了，代表为不同的 "),n("code",[t._v("Origin")]),t._v(" 缓存不同的资源")]),t._v(" "),n("h2",{attrs:{id:"总结-简要答案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结-简要答案"}},[t._v("#")]),t._v(" 总结 (简要答案)")]),t._v(" "),n("p",[t._v("CORS 如何指定多个域名？")]),t._v(" "),n("p",[n("strong",[t._v("根据请求头中的 "),n("code",[t._v("Origin")]),t._v(" 来设置响应头 "),n("code",[t._v("Access-Control-Allow-Origin")])]),t._v("，思路如下")]),t._v(" "),n("ol",[n("li",[t._v("总是设置 "),n("code",[t._v("Vary: Origin")]),t._v("，避免 CDN 缓存破坏 CORS 配置")]),t._v(" "),n("li",[t._v("如果请求头不带有 "),n("code",[t._v("Origin")]),t._v("，证明未跨域，则不作任何处理")]),t._v(" "),n("li",[t._v("如果请求头带有 "),n("code",[t._v("Origin")]),t._v("，证明浏览器访问跨域，根据 "),n("code",[t._v("Origin")]),t._v(" 设置相应的 "),n("code",[t._v("Access-Control-Allow-Origin: <Origin>")])])]),t._v(" "),n("p",[t._v("使用伪代码实现如下")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 Origin 请求头")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestOrigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Vary"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果没有，则跳过")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置响应头")]),t._v("\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("blockquote",[n("p",[t._v("相关问题："),n("a",{attrs:{href:"https://github.com/shfshanyue/Daily-Question/issues/330",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何避免 CDN 为 PC 端缓存移动端页面"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);